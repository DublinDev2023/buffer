using System;
using System.Collections;
using System.Collections.Generic;
using System.Linq;
using System.Reflection;
using Avro;
using Avro.Generic;

public static class AvroGenericMapper3
{
    // PUBLIC: Convert CLR object to GenericRecord
    public static GenericRecord ToGenericRecord(object obj, RecordSchema schema)
    {
        var record = new GenericRecord(schema);

        foreach (var field in schema.Fields)
        {
            var prop = obj.GetType().GetProperty(field.Name, BindingFlags.Public | BindingFlags.Instance | BindingFlags.IgnoreCase);
            if (prop == null) continue;

            var value = prop.GetValue(obj);
            var fieldSchema = UnwrapNullable(field.Schema);

            var avroValue = ConvertToAvroValue(value, field.Schema); // use full schema for Union handling
            record.Add(field.Name, avroValue);
        }

        return record;
    }

    // PRIVATE: Convert CLR value to Avro-compatible value
    private static object ConvertToAvroValue(object value, Schema schema)
    {
        if (value == null)
        {
            // Handle nullable unions
            if (schema is UnionSchema union && union.Schemas.Any(s => s.Tag == Schema.Type.Null))
                return null;

            throw new InvalidOperationException("Null not allowed for this schema.");
        }

        var actualSchema = UnwrapNullable(schema);

        switch (actualSchema)
        {
            case PrimitiveSchema _:
                return value;

            case RecordSchema recSchema:
                return ToGenericRecord(value, recSchema);

            case ArraySchema arraySchema:
                var list = new List<object>();
                foreach (var item in (IEnumerable)value)
                {
                    list.Add(ConvertToAvroValue(item, arraySchema.ItemSchema));
                }
                return list;

            case UnionSchema union:
                var targetSchema = union.Schemas.First(s => s.Tag != Schema.Type.Null);
                return ConvertToAvroValue(value, targetSchema);

            default:
                throw new NotSupportedException($"Unsupported schema: {schema.GetType().Name}");
        }
    }

    // PUBLIC: Convert Avro GenericRecord back to CLR object
    public static object FromGenericRecord(GenericRecord record, Type targetType)
    {
        var instance = Activator.CreateInstance(targetType);

        foreach (var field in record.Schema.Fields)
        {
            var prop = targetType.GetProperty(field.Name, BindingFlags.Public | BindingFlags.Instance | BindingFlags.IgnoreCase);
            if (prop == null || !prop.CanWrite) continue;

            var fieldValue = record[field.Name];
            var clrValue = ConvertToClrValue(fieldValue, prop.PropertyType, field.Schema);
            prop.SetValue(instance, clrValue);
        }

        return instance;
    }

    // PRIVATE: Convert Avro value back to CLR-compatible value
    private static object ConvertToClrValue(object value, Type targetType, Schema schema)
    {
        if (value == null) return null;

        var actualSchema = UnwrapNullable(schema);

        if (actualSchema is PrimitiveSchema)
        {
            return Convert.ChangeType(value, Nullable.GetUnderlyingType(targetType) ?? targetType);
        }

        if (actualSchema is RecordSchema recSchema)
        {
            return FromGenericRecord((GenericRecord)value, targetType);
        }

        if (actualSchema is ArraySchema arraySchema)
        {
            var itemType = targetType.IsArray
                ? targetType.GetElementType()
                : targetType.GetGenericArguments().FirstOrDefault() ?? typeof(object);

            var resultList = (IList)Activator.CreateInstance(typeof(List<>).MakeGenericType(itemType));

            foreach (var item in (IEnumerable)value)
            {
                var converted = ConvertToClrValue(item, itemType, arraySchema.ItemSchema);
                resultList.Add(converted);
            }

            if (targetType.IsArray)
            {
                var array = Array.CreateInstance(itemType, resultList.Count);
                resultList.CopyTo(array, 0);
                return array;
            }

            return resultList;
        }

        if (actualSchema is UnionSchema union)
        {
            var targetSubSchema = union.Schemas.First(s => s.Tag != Schema.Type.Null);
            return ConvertToClrValue(value, targetType, targetSubSchema);
        }

        throw new NotSupportedException($"Cannot convert Avro schema '{schema.Tag}' to CLR type '{targetType.Name}'");
    }

    // PRIVATE: Unwrap nullable union schemas (["null", "X"])
    private static Schema UnwrapNullable(Schema schema)
    {
        if (schema is UnionSchema union &&
            union.Schemas.Count == 2 &&
            union.Schemas.Any(s => s.Tag == Schema.Type.Null))
        {
            return union.Schemas.First(s => s.Tag != Schema.Type.Null);
        }
        return schema;
    }
}
